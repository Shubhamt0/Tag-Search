var express = require('express')
/*
var mysql = require('mysql');
var bodyParser = require('body-parser');

// Configure MySQL connection
var connection = mysql.createConnection({
	host: 'localhost',
	user: 'root',
	password: 'root',
	database: 'Tags_Project'
  })

//Establish MySQL connection
connection.connect(function(err) {
   if (err) 
      throw err
   else {
       console.log('Connected to MySQL');
       // Start the app when connection is ready
       app.listen(3000);
       console.log('Server listening on port 3000');
 }
});

*/

const Sequelize = require('sequelize');

const sequelize = new Sequelize('Tags_Project', 'root', 'root', {
  host: 'localhost',
  dialect: 'mysql',
  operatorAliases: false,
  pool: {
    max: 5,
    min: 0,
    acquire: 30000,
    idle: 10000
  }
});

sequelize
  .authenticate()
  .then(() => {
    console.log('Connection has been established successfully.');
  })
  .catch(err => {
    console.error('Unable to connect to the database:', err);
  });

globalThis.sequlize = sequelize;



module.exports = sequelize;

//for index file
let json =[];

// event is emitted after each line
rl.on('line', function(line) {
    line_no++;
    json.push(line);
    console.log(line);
});

// end
rl.on('close', function(line) {
    console.log('Total lines : ' + line_no);
   
});

router.get('/json', function(req, res, next) {
  let line_array=[];
  let object = {};
      
  for(let i=0;i<json.length;i++){
    line_array.push(json[i].split('='));
  }
  
  line_array.forEach((element)=> {
    object[element[0]] = element[1];
  });
  console.log('my object'+ object);
  
  
  var jsonContent = JSON.stringify(object);
  console.log(jsonContent);

  fs.writeFile("output.json",jsonContent, 'utf8', function (err) {
    if (err) {
        console.log("An error occured while writing JSON Object to File.");
        return console.log(err);
    }

    console.log("JSON file has been saved.");
  });

  //console.log(util.inspect(res));
  
  res.send(object);
});

app.get('/', function(req, res) {
  res.sendFile(path.join(__dirname+ '/JSON'));
});

app.post('/', function(req, res) {

var jsondata = req.body;
var values = [];

for(var i=0; i< jsondata.length; i++)
  values.push([jsondata[i].Tag_name,jsondata[i].Description]);

//Bulk insert using nested array [ [a,b],[c,d] ] will be flattened to (a,b),(c,d)
connection.query('INSERT INTO tags (Tag_name, Description) VALUES ?', [values], function(err,result) {
  if(err) {
     res.send('Error');
  }
 else {
     res.send('Success');
  }
});
});
